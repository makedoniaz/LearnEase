@using LearnEase.Models;
@model Feedback

@{
    var feedback = Model;
}

<style>
    .feedback-form {
        padding: 25px;
        border: 1px solid #d3d3d3;
        border-radius: 15px;
    }

    .error-div {
        color: red;
        font-size: 13px;
    }

    .hide {
        display: none;
    }

    .visible {
        display: block;
    }
</style>

<div class="change-page">
    <form name="change-form" class="feedback-form">
        <div class="form-text mb-3">
            <label class="mb-3 h5 text-dark" for="feedback-textarea">Feedback:</label>
            <textarea class="feedback-text form-control mb-1" id="feedback-textarea" rows="3" name="text" maxlength="500" required>@feedback.Text</textarea>
            <div class="error-div hide">This field cannot be empty!</div>
        </div>

        <div class="form-rating mb-4">
            <div class="rating-heading h5 mb-2">
                Rate course:
            </div>

             <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="Rating" id="rating1" value="1" name="Rating">
                <label class="form-check-label" for="rating1">1</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="Rating" id="rating2" value="2">
                <label class="form-check-label" for="rating2">2</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="Rating" id="rating3" value="3">
                <label class="form-check-label" for="rating3">3</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="Rating" id="rating4" value="4">
                <label class="form-check-label" for="rating4">4</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="Rating" id="rating5" value="5">
                <label class="form-check-label" for="rating5">5</label>
            </div>
        </div>

        <button type="submit" class="change-btn btn btn-dark px-4 btn-lg">Change</button>
    </form>
</div>

<script> 
    var button = document.querySelector('.change-btn')
    button.addEventListener('click', (e) => {
        e.preventDefault()
        PutFeedbackHandler()
    })

    function PutFeedbackHandler() {
        var feedback = GetFeedbackFromForm()

        if (feedback === null)
            return;
        
        fetch('/Feedback/' + @feedback.Id,
            {
                method: 'PUT',
                body: JSON.stringify(feedback),
                headers:
                {
                    'Content-type': 'application/json; charset=UTF-8' 
                }
            }
        )
        .then((response) => {
            if (!response.ok)
                throw new Error(response.statusText)

            RedirectToGetFeedbacksPage(@feedback.CourseId)
        })
        .catch((err) => console.log(err.message));
    }

    function GetFeedbackFromForm() {
        var feedbackText = document.forms['change-form']['text'].value
        var isValid = ValidateFeedbackInputHandler(feedbackText)

        if (!isValid)
            return null;

        var radiosArr = Array.from(document.forms['change-form']['Rating'])

        var checkedRadio = radiosArr.find((radio) => radio.checked)
        var feedbackRating = checkedRadio ? checkedRadio.value : null

        return {
            Id: @feedback.Id,
            Username: '@feedback.Username',
            Text: feedbackText,
            Rating: feedbackRating,
            CourseId: @feedback.CourseId,
            CreationDate: new Date(@feedback.CreationDate.ToString("yyyy,MM-1,dd"))
        }
    }

    function RedirectToGetFeedbacksPage(courseId) {
        window.location.assign('/Feedback/' + courseId);
    }

    function ValidateFeedbackInputHandler(feedbackText) {


        var isInvalid = (feedbackText.trim().length === 0)
        var errorDiv = document.querySelector('.error-div')
        errorDiv.classList.toggle('visible', isInvalid)

        return !isInvalid
    }
</script>